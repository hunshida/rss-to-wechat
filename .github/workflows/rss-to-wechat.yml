name: RSS to WeChat Hourly

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶ UTC æ—¶é—´çš„ 0 åˆ†è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00/16:00 ç­‰ +8å°æ—¶ï¼‰
  workflow_dispatch:      # ä¿ç•™æ‰‹åŠ¨è§¦å‘åŠŸèƒ½

jobs:
  rss-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip packages  # æ–°å¢ç¼“å­˜ä¼˜åŒ–æ­¥éª¤
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install feedparser requests python-dotenv

      - name: Run RSS check
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          RSS_FEED_URL: ${{ secrets.RSS_FEED_URL }}
        run: |
          python3 <<EOF
          import feedparser
          import requests
          import os
          from datetime import datetime, timedelta

          PUSHPLUS_TOKEN = os.getenv('PUSHPLUS_TOKEN')
          RSS_URL = os.getenv('RSS_FEED_URL')
          CHECK_HOURS = 1  # ä¿®æ”¹ä¸ºæ£€æŸ¥æœ€è¿‘1å°æ—¶å†…å®¹

          feed = feedparser.parse(RSS_URL)
          latest_entries = []
          now = datetime.now()

          for entry in feed.entries:
              published_time = datetime(*entry.published_parsed[:6])
              if now - published_time < timedelta(hours=CHECK_HOURS):
                  latest_entries.append({
                      'title': entry.title,
                      'link': entry.link,
                      'time': published_time.strftime("%Y-%m-%d %H:%M:%S")
                  })

          if latest_entries:
              message = f"ğŸ“¢ å‘ç° {len(latest_entries)} æ¡æ–°å†…å®¹ï¼š\n\n"
              for idx, item in enumerate(latest_entries, 1):
                  message += f"{idx}. [{item['title']}]({item['link']})\nå‘å¸ƒæ—¶é—´ï¼š{item['time']}\n\n"

              requests.post(
                  "https://www.pushplus.plus/send",
                  json={
                      "token": PUSHPLUS_TOKEN,
                      "title": "RSS æ›´æ–°æé†’ (æ¯å°æ—¶æ£€æŸ¥)",
                      "content": message,
                      "template": "markdown"
                  }
              )
              print("æ¨é€æˆåŠŸï¼")
          else:
              print("æš‚æ— æ–°å†…å®¹")
          EOF
