name: RSS to WeChat

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  rss-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install feedparser requests python-dotenv

      - name: Run RSS check
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          RSS_FEED_URL: ${{ secrets.RSS_FEED_URL }}
        run: |
          python3 <<EOF
          import feedparser
          import requests
          import os
          from datetime import datetime, timedelta

          PUSHPLUS_TOKEN = os.getenv('PUSHPLUS_TOKEN')
          RSS_URL = os.getenv('RSS_FEED_URL')

          # æ–°å¢žé”™è¯¯å¤„ç†é€»è¾‘
          try:
              feed = feedparser.parse(RSS_URL)
              
              # æ£€æµ‹ RSS è§£æžé”™è¯¯
              if feed.bozo:  # bozo=1 è¡¨ç¤ºè§£æžå¤±è´¥
                  error_msg = f"âŒ RSS è§£æžå¤±è´¥ï¼š{feed.bozo_exception}"
                  requests.post(
                      "https://www.pushplus.plus/send",
                      json={
                          "token": PUSHPLUS_TOKEN,
                          "title": "RSS ç›‘æŽ§å¼‚å¸¸",
                          "content": error_msg,
                          "template": "markdown"
                      }
                  )
                  print("å·²å‘é€é”™è¯¯é€šçŸ¥")
                  exit(1)

              # åŽŸæœ‰æ£€æŸ¥é€»è¾‘
              CHECK_HOURS = 24
              latest_entries = []
              now = datetime.now()

              for entry in feed.entries:
                  published_time = datetime(*entry.published_parsed[:6])
                  if now - published_time < timedelta(hours=CHECK_HOURS):
                      latest_entries.append({
                          'title': entry.title,
                          'link': entry.link,
                          'time': published_time.strftime("%Y-%m-%d %H:%M:%S")
                      })

              if latest_entries:
                  message = f"ðŸ“¢ å‘çŽ° {len(latest_entries)} æ¡æ–°å†…å®¹ï¼š\n\n"
                  for idx, item in enumerate(latest_entries, 1):
                      message += f"{idx}. [{item['title']}]({item['link']})\nå‘å¸ƒæ—¶é—´ï¼š{item['time']}\n\n"

                  requests.post(
                      "https://www.pushplus.plus/send",
                      json={
                          "token": PUSHPLUS_TOKEN,
                          "title": "RSS æ›´æ–°æé†’",
                          "content": message,
                          "template": "markdown"
                      }
                  )
                  print("æŽ¨é€æˆåŠŸï¼")
              else:
                  print("æš‚æ— æ–°å†…å®¹")

          except Exception as e:
              # é€šç”¨å¼‚å¸¸æ•èŽ·
              requests.post(
                  "https://www.pushplus.plus/send",
                  json={
                      "token": PUSHPLUS_TOKEN,
                      "title": "è„šæœ¬è¿è¡Œå¼‚å¸¸",
                      "content": f"âŒ å‘ç”Ÿæœªæ•èŽ·é”™è¯¯ï¼š{str(e)}",
                      "template": "markdown"
                  }
              )
              raise e  # æŠ›å‡ºé”™è¯¯è®© Actions æ˜¾ç¤ºå¤±è´¥
          EOF
